name: Build Android APK (Windows)

on:
  push:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build:
    runs-on: self-hosted
    timeout-minutes: 180

    env:
      # 配置代理（Windows代理 - 根据你的实际代理地址修改或删除）
      # http_proxy: http://127.0.0.1:7890
      # https_proxy: http://127.0.0.1:7890
      # NO_PROXY: localhost,127.0.0.1
      PYTHONUNBUFFERED: 1

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python 3.9
      uses: actions/setup-python@v5
      with:
        python-version: '3.9'

    - name: Install Chocolatey packages
      shell: powershell
      run: |
        # 安装必要的工具
        Write-Host "检查并安装必要的工具..."

        # 检查是否已安装 git
        if (-not (Get-Command git -ErrorAction SilentlyContinue)) {
          choco install git -y
        }

        # 检查是否已安装 openjdk
        if (-not (Get-Command java -ErrorAction SilentlyContinue)) {
          choco install openjdk17 -y
          refreshenv
        }

    - name: Set up Java environment
      shell: powershell
      run: |
        # 查找 Java 安装路径
        $javaPath = (Get-Command java -ErrorAction SilentlyContinue).Source
        if ($javaPath) {
          $javaHome = (Get-Item $javaPath).Directory.Parent.FullName
          Write-Host "Java found at: $javaHome"
          echo "JAVA_HOME=$javaHome" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
          echo "$javaHome\bin" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append
        } else {
          Write-Host "Java not found, will use system default"
        }

    - name: Install Buildozer
      shell: powershell
      run: |
        Write-Host "Installing Buildozer and dependencies..."

        # 创建虚拟环境
        python -m venv buildozer-venv

        # 激活虚拟环境
        .\buildozer-venv\Scripts\Activate.ps1

        # 升级 pip
        python -m pip install --upgrade pip

        # 安装 setuptools (Python 3.13+ 需要)
        pip install --upgrade setuptools

        # 安装 Cython 和 Buildozer
        pip install --upgrade cython==0.29.36
        pip install --upgrade buildozer==1.5.0

        # 验证安装
        buildozer --version

    - name: Cache Buildozer global directory
      uses: actions/cache@v4
      with:
        path: ~\.buildozer
        key: ${{ runner.os }}-buildozer-ndk27-${{ hashFiles('buildozer.spec') }}
        restore-keys: |
          ${{ runner.os }}-buildozer-ndk27-
          ${{ runner.os }}-buildozer-

    - name: Verify buildozer.spec
      shell: powershell
      run: |
        # 激活虚拟环境
        .\buildozer-venv\Scripts\Activate.ps1

        Write-Host "=== buildozer.spec content ==="
        Get-Content buildozer.spec

        Write-Host "=== Environment Info ==="
        Write-Host "OS: Windows"
        python --version
        java -version
        Write-Host "JAVA_HOME: $env:JAVA_HOME"

    - name: Install Android SDK and NDK
      shell: powershell
      run: |
        # 激活虚拟环境
        .\buildozer-venv\Scripts\Activate.ps1

        Write-Host "=== Installing Android SDK ==="
        # Buildozer 会自动下载 Android SDK 和 NDK
        # 这里只需要确保有足够的磁盘空间

        # 创建 .buildozer 目录（如果不存在）
        $buildozerDir = "$env:USERPROFILE\.buildozer"
        if (-not (Test-Path $buildozerDir)) {
          New-Item -ItemType Directory -Path $buildozerDir -Force
          Write-Host "Created .buildozer directory at: $buildozerDir"
        }

    - name: Build APK
      shell: powershell
      run: |
        # 激活虚拟环境
        .\buildozer-venv\Scripts\Activate.ps1

        Write-Host "=== Build Environment ==="
        Write-Host "JAVA_HOME: $env:JAVA_HOME"
        Write-Host "Python: $(python --version)"

        # 设置并行编译（使用所有CPU核心）
        $cpuCores = (Get-WmiObject Win32_ComputerSystem).NumberOfLogicalProcessors
        Write-Host "Using $cpuCores CPU cores for parallel compilation"

        # 设置环境变量
        $env:MAX_JOBS = $cpuCores
        $env:GRADLE_OPTS = "-Xmx2048m -Dorg.gradle.jvmargs=-Xmx2048m"

        Write-Host "=== Starting APK Build ==="
        Write-Host "This may take a while (30-60 minutes for first build)..."

        # 构建 APK (保存日志)
        buildozer -v android debug 2>&1 | Tee-Object -FilePath build_log.txt

        Write-Host "=== Build completed ==="

    - name: Check build result
      shell: powershell
      run: |
        Write-Host "=== Searching for APK files ==="
        Get-ChildItem -Path . -Filter "*.apk" -Recurse -File | Select-Object FullName

        if (Test-Path "bin") {
          Write-Host "=== Contents of bin/ ==="
          Get-ChildItem -Path bin | Format-Table Name, Length, LastWriteTime -AutoSize
        } else {
          Write-Host "Build failed - no bin/ directory"
          Write-Host "=== Last 100 lines of build log ==="
          Get-Content build_log.txt -Tail 100
          exit 1
        }

    - name: Upload APK
      if: success()
      uses: actions/upload-artifact@v4
      with:
        name: android-apk
        path: bin/*.apk
        if-no-files-found: error
        retention-days: 30

    - name: Upload build log
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: build-log
        path: build_log.txt
        if-no-files-found: warn

    - name: Create Release
      if: github.event_name == 'push' && github.ref == 'refs/heads/main'
      uses: softprops/action-gh-release@v1
      with:
        tag_name: v${{ github.run_number }}
        name: Release v${{ github.run_number }}
        files: bin/*.apk
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
