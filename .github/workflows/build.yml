name: Build Android APK (Windows)

on:
  push:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build:
    runs-on: self-hosted
    timeout-minutes: 180

    env:
      # 配置代理（如果第一次下载actions很慢，可以启用代理）
      # 如果你有代理服务器，取消下面3行的注释并修改为你的代理地址
      # http_proxy: http://127.0.0.1:7890
      # https_proxy: http://127.0.0.1:7890
      # NO_PROXY: localhost,127.0.0.1

      # Actions缓存说明：
      # - 首次运行需要下载actions，会比较慢（约2-5分钟）
      # - 下载后会缓存到 E:\actions-runner\_work\_actions\
      # - 后续构建会直接使用缓存，速度很快
      PYTHONUNBUFFERED: 1

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python 3.9
      shell: powershell
      run: |
        Write-Host "=== Setting up Python 3.9 ==="

        # 查找本地已安装的 Python 3.9
        $python39Paths = @(
          "C:\Python39\python.exe",
          "C:\Program Files\Python39\python.exe",
          "$env:LOCALAPPDATA\Programs\Python\Python39\python.exe"
        )

        $pythonPath = $null
        foreach ($path in $python39Paths) {
          if (Test-Path $path) {
            $pythonPath = $path
            Write-Host "Found Python 3.9 at: $path"
            break
          }
        }

        # 如果没找到，使用 py launcher
        if (-not $pythonPath) {
          Write-Host "Checking Python versions via py launcher..."
          $pyVersions = py -0 2>&1
          Write-Host $pyVersions

          if ($pyVersions -match '3\.9') {
            $pythonPath = "py -3.9"
            Write-Host "Python 3.9 available via py launcher"
          }
        }

        # 如果还是没找到，尝试安装
        if (-not $pythonPath) {
          Write-Host "Python 3.9 not found locally, installing via Chocolatey..."
          choco install python39 -y --force
          refreshenv
          $pythonPath = "C:\Python39\python.exe"
        }

        # 验证 Python 版本
        if ($pythonPath -like "*py -3.9*") {
          py -3.9 --version
        } else {
          & $pythonPath --version
        }

        # 将 Python 路径添加到环境变量
        if ($pythonPath -notlike "*py -3.9*") {
          $pythonDir = Split-Path $pythonPath -Parent
          echo "$pythonDir" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append
          echo "$pythonDir\Scripts" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append
          Write-Host "Added Python to PATH: $pythonDir"
        }

    - name: Install Chocolatey packages
      shell: powershell
      run: |
        # 安装必要的工具
        Write-Host "检查并安装必要的工具..."

        # 检查是否已安装 git
        if (-not (Get-Command git -ErrorAction SilentlyContinue)) {
          choco install git -y
        }

        # 检查是否已安装 openjdk
        if (-not (Get-Command java -ErrorAction SilentlyContinue)) {
          choco install openjdk17 -y
          refreshenv
        }

    - name: Set up Java environment
      shell: powershell
      run: |
        # 查找 Java 安装路径
        $javaPath = (Get-Command java -ErrorAction SilentlyContinue).Source
        if ($javaPath) {
          $javaHome = (Get-Item $javaPath).Directory.Parent.FullName
          Write-Host "Java found at: $javaHome"
          echo "JAVA_HOME=$javaHome" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
          echo "$javaHome\bin" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append
        } else {
          Write-Host "Java not found, will use system default"
        }

    - name: Install Buildozer
      shell: powershell
      run: |
        Write-Host "Installing Buildozer and dependencies..."

        # 创建虚拟环境
        python -m venv buildozer-venv

        # 激活虚拟环境
        .\buildozer-venv\Scripts\Activate.ps1

        # 升级 pip
        python -m pip install --upgrade pip

        # 安装 setuptools (Python 3.13+ 需要)
        pip install --upgrade setuptools

        # 安装 Cython 和 Buildozer
        pip install --upgrade cython==0.29.36
        pip install --upgrade buildozer==1.5.0

        # 验证安装
        buildozer --version

    - name: Cache Buildozer global directory
      uses: actions/cache@v4
      with:
        path: ~\.buildozer
        key: ${{ runner.os }}-buildozer-ndk27-${{ hashFiles('buildozer.spec') }}
        restore-keys: |
          ${{ runner.os }}-buildozer-ndk27-
          ${{ runner.os }}-buildozer-

    - name: Verify buildozer.spec
      shell: powershell
      run: |
        # 激活虚拟环境
        .\buildozer-venv\Scripts\Activate.ps1

        Write-Host "=== buildozer.spec content ==="
        Get-Content buildozer.spec

        Write-Host "=== Environment Info ==="
        Write-Host "OS: Windows"
        python --version
        java -version
        Write-Host "JAVA_HOME: $env:JAVA_HOME"

    - name: Install Android SDK and NDK
      shell: powershell
      run: |
        # 激活虚拟环境
        .\buildozer-venv\Scripts\Activate.ps1

        Write-Host "=== Installing Android SDK ==="
        # Buildozer 会自动下载 Android SDK 和 NDK
        # 这里只需要确保有足够的磁盘空间

        # 创建 .buildozer 目录（如果不存在）
        $buildozerDir = "$env:USERPROFILE\.buildozer"
        if (-not (Test-Path $buildozerDir)) {
          New-Item -ItemType Directory -Path $buildozerDir -Force
          Write-Host "Created .buildozer directory at: $buildozerDir"
        }

    - name: Build APK
      shell: powershell
      run: |
        # 激活虚拟环境
        .\buildozer-venv\Scripts\Activate.ps1

        Write-Host "=== Build Environment ==="
        Write-Host "JAVA_HOME: $env:JAVA_HOME"
        Write-Host "Python: $(python --version)"
        Write-Host "Current User: $env:USERNAME"

        # 设置并行编译（使用所有CPU核心）
        $cpuCores = (Get-WmiObject Win32_ComputerSystem).NumberOfLogicalProcessors
        Write-Host "Using $cpuCores CPU cores for parallel compilation"

        # 设置环境变量
        $env:MAX_JOBS = $cpuCores
        $env:GRADLE_OPTS = "-Xmx2048m -Dorg.gradle.jvmargs=-Xmx2048m"

        # 直接修改buildozer源代码移除root检查
        Write-Host "=== Patching Buildozer source code ==="

        $buildozerModule = python -c "import buildozer; print(buildozer.__file__)"
        $buildozerDir = Split-Path $buildozerModule -Parent
        $buildozerInitFile = Join-Path $buildozerDir "__init__.py"

        Write-Host "Buildozer module location: $buildozerModule"
        Write-Host "Patching file: $buildozerInitFile"

        if (Test-Path $buildozerInitFile) {
          $content = Get-Content $buildozerInitFile -Raw

          # 查找并移除root检查代码
          if ($content -match "running as root") {
            Write-Host "Found root check in buildozer code, patching..."

            # 显示原始代码段（调试用）
            $lines = $content -split "`n"
            for ($i = 0; $i -lt $lines.Length; $i++) {
              if ($lines[$i] -match "running as root") {
                Write-Host "Found at line $($i+1): $($lines[$i])"
                break
              }
            }

            # 使用多种方法确保patch成功
            # 方法1: 替换包含getuid的if语句
            $content = $content -replace "if hasattr\(os,\s*['\`"]getuid['\`"]\):", "if False and hasattr(os, 'getuid'):"

            # 方法2: 直接替换getuid() == 0的检查
            $content = $content -replace "if os\.getuid\(\)\s*==\s*0:", "if False:"

            # 方法3: 注释掉包含ANSI颜色码的print语句
            $content = $content -replace "print\('\\033\[91m\\033\[1mBuildozer is running as root!", "# print('\\033[91m\\033[1mBuildozer is running as root!"
            $content = $content -replace "print\('\\033\[91mThis is \\033\[1mnot\\033\[0m", "# print('\\033[91mThis is \\033[1mnot\\033[0m"

            # 方法4: 如果用的是双引号
            $content = $content -replace 'print\("\\033\[91m\\033\[1mBuildozer is running as root!', '# print("\\033[91m\\033[1mBuildozer is running as root!'
            $content = $content -replace 'print\("\\033\[91mThis is \\033\[1mnot\\033\[0m', '# print("\\033[91mThis is \\033[1mnot\\033[0m'

            # 方法5: 更通用的方式 - 匹配任何包含"running as root"的print
            $content = $content -replace "print\([^)]*running as root[^)]*\)", "# print('disabled root check')"

            Set-Content -Path $buildozerInitFile -Value $content -Encoding UTF8

            # 验证patch - 检查多种可能的模式
            $patchedContent = Get-Content $buildozerInitFile -Raw
            $checkPatterns = @(
              "if False and hasattr",
              "if False:",
              "# print.*running as root",
              "# print\('disabled root check'\)"
            )
            $patchSuccess = $false
            foreach ($pattern in $checkPatterns) {
              if ($patchedContent -match $pattern) {
                Write-Host "✓ Buildozer patched successfully - found pattern: $pattern"
                $patchSuccess = $true
                break
              }
            }
            if (-not $patchSuccess) {
              Write-Host "⚠ Warning: Patch may not have been applied correctly"
              Write-Host "Debug: Showing lines around 'running as root':"
              $lines = $patchedContent -split "`n"
              for ($i = 0; $i -lt $lines.Length; $i++) {
                if ($lines[$i] -match "running as root") {
                  $start = [Math]::Max(0, $i - 2)
                  $end = [Math]::Min($lines.Length - 1, $i + 2)
                  for ($j = $start; $j -le $end; $j++) {
                    Write-Host "$($j+1): $($lines[$j])"
                  }
                  break
                }
              }
            }
          } else {
            Write-Host "Root check code not found in expected location"
          }
        } else {
          Write-Host "Warning: Could not find buildozer __init__.py file"
        }

        Write-Host "=== Starting APK Build ==="
        Write-Host "This may take a while (30-60 minutes for first build)..."

        # 设置Python输出为UTF-8，确保错误信息被正确捕获
        $env:PYTHONIOENCODING = "utf-8"
        $env:PYTHONUNBUFFERED = "1"

        # 构建 APK (使用更强的错误捕获)
        $ErrorActionPreference = "Continue"  # 确保即使buildozer崩溃也能捕获输出

        # 使用Start-Transcript捕获所有输出
        $transcriptFile = "build_transcript.txt"
        Start-Transcript -Path $transcriptFile

        try {
          # 直接运行，让所有输出都被transcript捕获
          & buildozer -v android debug
          $buildExitCode = $LASTEXITCODE

          Stop-Transcript

          if ($buildExitCode -ne 0) {
            Write-Host "=== Build failed with exit code: $buildExitCode ==="
            Write-Host "=== Full build transcript ==="
            if (Test-Path $transcriptFile) {
              Get-Content $transcriptFile | Select-Object -Last 300
            }
            throw "Build failed with exit code $buildExitCode"
          } else {
            Write-Host "=== Build completed successfully ==="
          }
        } catch {
          Stop-Transcript -ErrorAction SilentlyContinue
          Write-Host "=== Build failed with exception ==="
          Write-Host $_.Exception.Message
          Write-Host $_.ScriptStackTrace
          Write-Host "=== Full build transcript ==="
          if (Test-Path $transcriptFile) {
            Get-Content $transcriptFile | Select-Object -Last 300
          }
          throw
        }

    - name: Check build result
      shell: powershell
      run: |
        Write-Host "=== Searching for APK files ==="
        Get-ChildItem -Path . -Filter "*.apk" -Recurse -File | Select-Object FullName

        if (Test-Path "bin") {
          Write-Host "=== Contents of bin/ ==="
          Get-ChildItem -Path bin | Format-Table Name, Length, LastWriteTime -AutoSize
        } else {
          Write-Host "Build failed - no bin/ directory"
          Write-Host "=== Last 100 lines of build log ==="
          Get-Content build_log.txt -Tail 100
          exit 1
        }

    - name: Upload APK
      if: success()
      uses: actions/upload-artifact@v4
      with:
        name: android-apk
        path: bin/*.apk
        if-no-files-found: error
        retention-days: 30

    - name: Upload build log
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: build-log
        path: build_log.txt
        if-no-files-found: warn

    - name: Create Release
      if: github.event_name == 'push' && github.ref == 'refs/heads/main'
      uses: softprops/action-gh-release@v1
      with:
        tag_name: v${{ github.run_number }}
        name: Release v${{ github.run_number }}
        files: bin/*.apk
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
