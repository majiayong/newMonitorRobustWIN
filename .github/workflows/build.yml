name: Build Android APK (Fixed NDK)

on:
  push:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build:
    runs-on: self-hosted
    timeout-minutes: 180

    env:
      # é…ç½®ä»£ç†ï¼ˆmacOS VPNä»£ç†ï¼‰
      HTTP_PROXY: http://127.0.0.1:7890
      HTTPS_PROXY: http://127.0.0.1:7890
      http_proxy: http://127.0.0.1:7890
      https_proxy: http://127.0.0.1:7890
      NO_PROXY: localhost,127.0.0.1

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python 3.9
      uses: actions/setup-python@v5
      with:
        python-version: '3.9'

    - name: ðŸ“¦ Install system dependencies (macOS)
      if: runner.os == 'macOS'
      run: |
        # macOSä½¿ç”¨Homebrewå®‰è£…ä¾èµ–
        brew install --quiet \
          autoconf automake libtool pkg-config \
          zlib ncurses cmake openssl ccache ninja \
          sdl2 sdl2_image sdl2_ttf sdl2_mixer

    - name: ðŸ“¦ Install system dependencies (Linux)
      if: runner.os == 'Linux'
      run: |
        sudo apt-get update -qq
        sudo apt-get install -y \
          build-essential git ffmpeg \
          libsdl2-dev libsdl2-image-dev libsdl2-mixer-dev libsdl2-ttf-dev \
          libportmidi-dev libswscale-dev libavformat-dev libavcodec-dev \
          zlib1g-dev openjdk-17-jdk \
          autoconf libtool pkg-config libffi-dev libssl-dev

    - name: Set up Java environment
      run: |
        # macOSå’ŒLinuxçš„Javaè·¯å¾„ä¸åŒ
        if [[ "$RUNNER_OS" == "macOS" ]]; then
          echo "Running on macOS - Java will be auto-detected"
        else
          echo "JAVA_HOME=/usr/lib/jvm/java-17-openjdk-amd64" >> $GITHUB_ENV
          echo "/usr/lib/jvm/java-17-openjdk-amd64/bin" >> $GITHUB_PATH
        fi

    - name: Install Buildozer
      run: |
        # ç¡®ä¿pipä½¿ç”¨ä»£ç†
        export HTTP_PROXY=http://127.0.0.1:7890
        export HTTPS_PROXY=http://127.0.0.1:7890

        python -m pip install --upgrade pip
        pip install --upgrade cython==0.29.36
        pip install --upgrade buildozer==1.5.0
        buildozer --version

    - name: Cache Buildozer global directory
      uses: actions/cache@v4
      with:
        path: ~/.buildozer
        key: ${{ runner.os }}-buildozer-ndk27-${{ hashFiles('buildozer.spec') }}
        restore-keys: |
          ${{ runner.os }}-buildozer-ndk27-
          ${{ runner.os }}-buildozer-

    - name: Verify buildozer.spec
      run: |
        # é…ç½®gitä½¿ç”¨ä»£ç†
        git config --global http.proxy http://127.0.0.1:7890
        git config --global https.proxy http://127.0.0.1:7890

        echo "=== buildozer.spec content ==="
        cat buildozer.spec

        echo "=== Environment Info ==="
        echo "OS: $RUNNER_OS"
        python --version
        java -version 2>&1 | head -3
        echo "HTTP_PROXY: $HTTP_PROXY"

    - name: Build APK with correct NDK
      run: |
        echo "=== Build Environment ==="
        echo "ANDROID_NDK: $ANDROID_NDK"
        echo "ANDROID_NDK_HOME: $ANDROID_NDK_HOME"
        echo "JAVA_HOME: $JAVA_HOME"

        # ç¡®ä¿æ‰€æœ‰ä¸‹è½½æ“ä½œéƒ½ä½¿ç”¨ä»£ç†
        export HTTP_PROXY=http://127.0.0.1:7890
        export HTTPS_PROXY=http://127.0.0.1:7890
        export http_proxy=http://127.0.0.1:7890
        export https_proxy=http://127.0.0.1:7890

        # æž„å»º APK
        buildozer -v android debug 2>&1 | tee build_log.txt

    - name: Check build result
      run: |
        echo "=== Searching for APK files ==="
        find . -name "*.apk" -type f
        if [ -d "bin" ]; then
          echo "=== Contents of bin/ ==="
          ls -lh bin/
        else
          echo "âœ— Build failed - no bin/ directory"
          echo "=== Last 100 lines of build log ==="
          tail -100 build_log.txt
          exit 1
        fi

    - name: Upload APK
      if: success()
      uses: actions/upload-artifact@v4
      with:
        name: android-apk
        path: bin/*.apk
        if-no-files-found: error
        retention-days: 30

    - name: Upload build log
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: build-log
        path: build_log.txt
        if-no-files-found: warn

    - name: Create Release
      if: github.event_name == 'push' && github.ref == 'refs/heads/main'
      uses: softprops/action-gh-release@v1
      with:
        tag_name: v${{ github.run_number }}
        name: Release v${{ github.run_number }}
        files: bin/*.apk
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
