name: Build Android APK (Fixed NDK)

on:
  push:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-20.04

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python 3.9
      uses: actions/setup-python@v5
      with:
        python-version: '3.9'

    - name: Install system dependencies
      run: |
        sudo apt-get update -qq
        sudo apt-get install -y \
          build-essential \
          git \
          ffmpeg \
          libsdl2-dev \
          libsdl2-image-dev \
          libsdl2-mixer-dev \
          libsdl2-ttf-dev \
          libportmidi-dev \
          libswscale-dev \
          libavformat-dev \
          libavcodec-dev \
          zlib1g-dev \
          openjdk-17-jdk \
          autoconf \
          libtool \
          pkg-config \
          libffi-dev \
          libssl-dev

    - name: Set up Java and Android environment
      run: |
        echo "JAVA_HOME=/usr/lib/jvm/java-17-openjdk-amd64" >> $GITHUB_ENV
        echo "/usr/lib/jvm/java-17-openjdk-amd64/bin" >> $GITHUB_PATH

        # ä½¿ç”¨ç³»ç»Ÿå·²å®‰è£…çš„ Android SDK å’Œ NDK
        echo "ANDROID_HOME=/usr/local/lib/android/sdk" >> $GITHUB_ENV
        echo "ANDROID_SDK_ROOT=/usr/local/lib/android/sdk" >> $GITHUB_ENV

        # ðŸ”§ å…³é”®ä¿®å¤ï¼šè®¾ç½® NDK è·¯å¾„åˆ°ç‰ˆæœ¬ 25 æˆ–æ›´é«˜
        # GitHub Actions runner æœ‰å¤šä¸ª NDK ç‰ˆæœ¬ï¼Œä½¿ç”¨æœ€æ–°çš„
        if [ -d "/usr/local/lib/android/sdk/ndk/27.3.13750724" ]; then
          echo "ANDROID_NDK_HOME=/usr/local/lib/android/sdk/ndk/27.3.13750724" >> $GITHUB_ENV
          echo "ANDROID_NDK=/usr/local/lib/android/sdk/ndk/27.3.13750724" >> $GITHUB_ENV
          echo "âœ“ Using NDK 27"
        elif [ -d "/usr/local/lib/android/sdk/ndk-bundle" ]; then
          echo "ANDROID_NDK_HOME=/usr/local/lib/android/sdk/ndk-bundle" >> $GITHUB_ENV
          echo "ANDROID_NDK=/usr/local/lib/android/sdk/ndk-bundle" >> $GITHUB_ENV
          echo "âœ“ Using NDK bundle"
        fi

        # æ˜¾ç¤ºç‰ˆæœ¬ä¿¡æ¯
        echo "=== Environment Info ==="
        java -version
        ls -la /usr/local/lib/android/sdk/ndk/ || echo "No NDK directory"

    - name: Install Buildozer
      run: |
        python -m pip install --upgrade pip
        pip install --upgrade cython==0.29.36
        pip install --upgrade buildozer==1.5.0
        buildozer --version

    - name: Cache Buildozer global directory
      uses: actions/cache@v4
      with:
        path: ~/.buildozer
        key: ${{ runner.os }}-buildozer-ndk27-${{ hashFiles('buildozer.spec') }}
        restore-keys: |
          ${{ runner.os }}-buildozer-ndk27-
          ${{ runner.os }}-buildozer-

    - name: Verify buildozer.spec
      run: |
        echo "=== buildozer.spec content ==="
        cat buildozer.spec

    - name: Build APK with correct NDK
      run: |
        echo "=== Build Environment ==="
        echo "ANDROID_NDK: $ANDROID_NDK"
        echo "ANDROID_NDK_HOME: $ANDROID_NDK_HOME"
        echo "JAVA_HOME: $JAVA_HOME"

        # æž„å»º APK
        buildozer -v android debug 2>&1 | tee build_log.txt

    - name: Check build result
      run: |
        echo "=== Searching for APK files ==="
        find . -name "*.apk" -type f
        if [ -d "bin" ]; then
          echo "=== Contents of bin/ ==="
          ls -lh bin/
        else
          echo "âœ— Build failed - no bin/ directory"
          echo "=== Last 100 lines of build log ==="
          tail -100 build_log.txt
          exit 1
        fi

    - name: Upload APK
      if: success()
      uses: actions/upload-artifact@v4
      with:
        name: android-apk
        path: bin/*.apk
        if-no-files-found: error
        retention-days: 30

    - name: Upload build log
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: build-log
        path: build_log.txt
        if-no-files-found: warn

    - name: Create Release
      if: github.event_name == 'push' && github.ref == 'refs/heads/main'
      uses: softprops/action-gh-release@v1
      with:
        tag_name: v${{ github.run_number }}
        name: Release v${{ github.run_number }}
        files: bin/*.apk
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
